name: "Master Deploy: ArthaPay Platform"

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: "Client name (e.g., Voltica)"
        type: string
        required: true
        default: "Voltica"
      environment:
        description: "Environment to deploy (e.g., tst, stg, prd)"
        type: choice
        options:
          - tst
          - stg
          - prd
        default: "tst"
      module:
        description: "Application module to deploy (UI or 'all')"
        type: choice
        options:
          - ArthapayUI
          - all
        default: "ArthapayUI"

jobs:
  # ===================================================================
  # JOB 1: CALL THE INFRASTRUCTURE WORKFLOW
  # ===================================================================
  deploy-infra:
    name: "Job 1: Deploy Infrastructure"
    uses: ./.github/workflows/callable-deploy-infra.yml
    with:
      client_name: ${{ github.event.inputs.client_name }}
      environment: ${{ github.event.inputs.environment }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      VM_ADMIN_PASSWORD: ${{ secrets.VM_ADMIN_PASSWORD }}
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      MAILGUN_KEY: ${{ secrets.MAILGUN_KEY }}
      TWILIO_SID: ${{ secrets.TWILIO_SID }}

  # ===================================================================
  # JOB 2: CALL THE REACT UI DEPLOY WORKFLOW
  # ===================================================================
  deploy-ui:
    name: "Job 2: Deploy React UI"
    needs: deploy-infra 
    if: github.event.inputs.module == 'ArthapayUI' || github.event.inputs.module == 'all'
    uses: ./.github/workflows/callable-deploy-ui.yml
    with:
      client_name: ${{ github.event.inputs.client_name }}
      environment: ${{ github.event.inputs.environment }}
      swa_deploy_token: ${{ needs.deploy-infra.outputs.static_web_app_api_key }}
    secrets:
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }} 

  # ===================================================================
  # JOB 3: CALL THE SQL CONFIGURATION WORKFLOW
  # ===================================================================
  configure-sql:
    name: "Job 3: Configure SQL Database"
    needs: deploy-infra 
    uses: ./.github/workflows/callable-configure-sql.yml
    with:
      # --- FIX: Pass the client_name to the script ---
      client_name: ${{ github.event.inputs.client_name }}
      environment: ${{ github.event.inputs.environment }}
      vm_rg_name: ${{ needs.deploy-infra.outputs.vm_rg_name }}
      vm_name: ${{ needs.deploy-infra.outputs.vm_name }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      VM_ADMIN_PASSWORD: ${{ secrets.VM_ADMIN_PASSWORD }}
      APP_SQL_PASSWORD: ${{ secrets.APP_SQL_PASSWORD }}

  # ===================================================================
  # JOB 4: CALL THE ZAPIER TRIGGER WORKFLOW
  # ===================================================================
  trigger-zapier:
    name: "Job 4: Trigger Zapier Webhook"
    needs: [deploy-ui, configure-sql]
    uses: ./.github/workflows/callable-trigger-zapier.yml
    with:
      client_name: ${{ github.event.inputs.client_name }}
      environment: ${{ github.event.inputs.environment }}
      app_url: ${{ needs.deploy-infra.outputs.static_web_app_url }}
    secrets:
      ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}