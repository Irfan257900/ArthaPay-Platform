name: "Reusable: Configure SQL Database"

on:
  workflow_call:
    inputs:
      client_name:
        type: string
        required: true
      environment:
        type: string
        required: true
      vm_rg_name:
        type: string
        required: true
      vm_name:
        type: string
        required: true
    secrets:
      AZURE_CREDENTIALS:
        required: true
      VM_ADMIN_PASSWORD:         # SQL admin password
        required: true
      APP_SQL_PASSWORD:          # artha_app_user password
        required: true

  workflow_dispatch:
    inputs:
      client_name:
        description: "Client name (e.g., Artha)"
        type: string
        required: true
        default: "Artha"
      environment:
        description: "Environment to deploy (e.g., tst, stg, prd)"
        type: choice
        options: [tst, stg, prd]
        default: "tst"
      vm_rg_name:
        description: "VM Resource Group Name"
        type: string
        required: true
      vm_name:
        description: "VM Name"
        type: string
        required: true

jobs:
  configure-sql:
    name: "Configure SQL Database"
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.client_name || github.event.inputs.client_name }}-${{ inputs.environment || github.event.inputs.environment }}

    steps:

      - name: "1. Log in to Azure"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: "2. Run SQL Configuration Script"
        uses: azure/powershell@v1
        with:
          inlineScript: |
            echo "Starting SQL Server configuration..."

            $ClientName = "${{ inputs.client_name || github.event.inputs.client_name }}"
            $DbName  = "${ClientName}DB"               # ArthaDB
            $DbUser  = "${ClientName}_app_user"        # artha_app_user

            $SqlAdminUser = "Volticatstadmin"
            $SqlAdminPass = "${{ secrets.VM_ADMIN_PASSWORD }}"
            $AppUserPass  = "${{ secrets.APP_SQL_PASSWORD }}"

            # ---- SQL SCRIPT FOR RUNCOMMAND ----
            $scriptBlock = @"
Write-Host '========================================='
Write-Host ' Starting SQL Server Configuration '
Write-Host '========================================='

`$ErrorActionPreference = "Stop"

# Queries
`$createDbQuery     = "IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'$DbName') CREATE DATABASE [$DbName];"
`$createLoginQuery  = "IF NOT EXISTS (SELECT name FROM sys.sql_logins WHERE name = N'$DbUser') CREATE LOGIN [$DbUser] WITH PASSWORD = '$AppUserPass';"
`$createUserQuery   = "USE [$DbName]; IF NOT EXISTS (SELECT name FROM sys.database_principals WHERE name = N'$DbUser') BEGIN CREATE USER [$DbUser] FOR LOGIN [$DbUser]; ALTER ROLE db_owner ADD MEMBER [$DbUser]; END;"

try {
    Write-Host "Step 1: Creating Database $DbName"
    sqlcmd -S localhost -U $SqlAdminUser -P $SqlAdminPass -Q "`$createDbQuery" -b

    Write-Host "Step 2: Creating Login $DbUser"
    sqlcmd -S localhost -U $SqlAdminUser -P $SqlAdminPass -Q "`$createLoginQuery" -b

    Write-Host "Step 3: Creating Database User $DbUser"
    sqlcmd -S localhost -U $SqlAdminUser -P $SqlAdminPass -Q "`$createUserQuery" -b

    Write-Host "======== SQL CONFIGURATION SUCCESS ========="
}
catch {
    Write-Host "======== SQL CONFIGURATION FAILED ========="
    Write-Host $_.Exception.Message
    exit 1
}
"@

            echo "Sending script to VM..."

            Invoke-AzVMRunCommand `
              -ResourceGroupName "${{ inputs.vm_rg_name || github.event.inputs.vm_rg_name }}" `
              -VMName "${{ inputs.vm_name || github.event.inputs.vm_name }}" `
              -CommandId "RunPowerShellScript" `
              -ScriptString $scriptBlock

          azPSVersion: latest
