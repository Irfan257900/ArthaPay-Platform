name: "Reusable: Configure SQL Database"

on:
  workflow_call:
    inputs:
      client_name:
        type: string
        required: true
      environment:
        type: string
        required: true
      vm_rg_name:
        type: string
        required: true
      vm_name:
        type: string
        required: true
    secrets:
      AZURE_CREDENTIALS:
        required: true
      VM_ADMIN_PASSWORD:
        required: true
      APP_SQL_PASSWORD:
        required: true

  workflow_dispatch:
    inputs:
      client_name:
        description: "Client name (e.g., Artha)"
        type: string
        required: true
        default: "Artha"
      environment:
        description: "Environment to deploy (e.g., tst, stg, prd)"
        type: choice
        options:
          - tst
          - stg
          - prd
        default: "tst"
      vm_rg_name:
        description: "VM Resource Group Name"
        type: string
        required: true
        default: "rg-Artha-tst-vm"
      vm_name:
        description: "VM Name"
        type: string
        required: true
        default: "Artha-tst-sqlvm"

jobs:
  configure-sql:
    name: "Configure SQL Database"
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.client_name || github.event.inputs.client_name }}-${{ inputs.environment || github.event.inputs.environment }}

    steps:
      - name: "1. Log in to Azure"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: "2. Run SQL Configuration Script"
        uses: azure/powershell@v1
        with:
          inlineScript: |
            Write-Host "Installing Az.Compute module..."
            Install-Module -Name Az.Compute -Repository PSGallery -Force -AllowClobber -Scope CurrentUser

            Write-Host "Preparing SQL Server configuration..."

            $ClientName = "${{ inputs.client_name || github.event.inputs.client_name }}"
            $DbName = "$($ClientName)DB"
            $DbUser = "$($ClientName)_app_user"

            Write-Host "Database Name: $DbName"
            Write-Host "Database User: $DbUser"

            # ------------------ SCRIPT SENT TO VM ------------------
            $scriptBlock = @"
Write-Host '========================================='
Write-Host 'Starting SQL Server Database Configuration'
Write-Host "Admin User: $env:SQL_ADMIN_USER"

# SQL Queries
\$createDbQuery = "IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'$DbName') BEGIN CREATE DATABASE [$DbName]; END"
\$createLoginQuery = "IF NOT EXISTS (SELECT name FROM sys.sql_logins WHERE name = N'$DbUser') BEGIN CREATE LOGIN [$DbUser] WITH PASSWORD = '$($env:SQL_APP_PASS)', CHECK_POLICY = OFF; END"
\$createUserQuery = "USE [$DbName]; IF NOT EXISTS (SELECT name FROM sys.database_principals WHERE name = N'$DbUser') BEGIN CREATE USER [$DbUser] FOR LOGIN [$DbUser]; ALTER ROLE db_owner ADD MEMBER [$DbUser]; END"

try {
    Write-Host "Executing DB creation..."
    sqlcmd.exe -S localhost -U "$env:SQL_ADMIN_USER" -P "$env:SQL_ADMIN_PASS" -Q "\$createDbQuery" -b

    Write-Host "Executing login creation..."
    sqlcmd.exe -S localhost -U "$env:SQL_ADMIN_USER" -P "$env:SQL_ADMIN_PASS" -Q "\$createLoginQuery" -b

    Write-Host "Executing DB user creation..."
    sqlcmd.exe -S localhost -U "$env:SQL_ADMIN_USER" -P "$env:SQL_ADMIN_PASS" -Q "\$createUserQuery" -b

    Write-Host '========================================='
    Write-Host '✅ SQL configuration completed successfully!'
    Write-Host '========================================='
}
catch {
    Write-Host '❌ SQL CONFIGURATION FAILED'
    Write-Host "Error: $($_.Exception.Message)"
    exit 1
}
"@
            # ------------------------------------------------------

            Write-Host "Sending configuration script to VM..."

            Invoke-AzVMRunCommand `
              -ResourceGroupName "${{ inputs.vm_rg_name || github.event.inputs.vm_rg_name }}" `
              -VMName "${{ inputs.vm_name || github.event.inputs.vm_name }}" `
              -CommandId "RunPowerShellScript" `
              -ScriptString $scriptBlock `
              -ErrorAction Stop

          azPSVersion: "latest"

        env:
          SQL_ADMIN_USER: "Volticatstadmin"
          SQL_ADMIN_PASS: ${{ secrets.VM_ADMIN_PASSWORD }}
          SQL_APP_PASS: ${{ secrets.APP_SQL_PASSWORD }}
